# Build stage - compile TypeScript
FROM node:18-alpine AS builder

# Build argument for API URL (default to test API)
ARG API_URL=http://localhost:3001

WORKDIR /app

# Copy package files and install dependencies
COPY package*.json ./
COPY tsconfig.frontend.json ./
RUN npm ci

# Copy TypeScript source
COPY script.ts ./

# Replace API_BASE_URL with the build argument value, then compile
RUN sed -i "s|http://localhost:3000|${API_URL}|g" script.ts && \
    npm run build:frontend

# Production stage - serve with nginx
FROM nginx:alpine

# Copy static files
COPY ui.html /usr/share/nginx/html/index.html
COPY styles.css /usr/share/nginx/html/styles.css
COPY nginx.test.conf /etc/nginx/conf.d/default.conf

# Copy compiled JavaScript from builder
COPY --from=builder /app/script.js /usr/share/nginx/html/script.js

EXPOSE 80
